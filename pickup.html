<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Pickup Details ‚Äì Campus Marketplace</title>
  <style>
    .spinner-btn {
      width: 28px; height: 28px; border-radius: 50%;
      background-color: #a78bfa; color: white; font-weight: bold;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s; cursor: pointer;
    }
    .spinner-btn:hover { background-color: #7c3aed; }

    .time-input {
      width: 64px;
      text-align: center;
      border-radius: 0.5rem;
      border: 1px solid #c4b5fd;
      background-color: #e9d5ff;
      color: #4c1d95;
      font-weight: 600;
      padding: 0.25rem 0;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-100 to-blue-100 min-h-screen flex flex-col">

  <!-- Navbar -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
    <h1 class="text-2xl font-bold text-purple-700">Campus Marketplace</h1>
  </header>

  <main class="flex-1 p-6 max-w-md mx-auto flex flex-col gap-6">
    <h2 class="text-3xl font-bold text-purple-700 text-center">Pickup Details</h2>

    <!-- Form -->
    <form id="pickupForm" class="bg-white/70 backdrop-blur p-6 space-y-4 rounded-2xl shadow-lg">
      <input type="text" id="productName" readonly
        class="w-full border rounded-lg py-2 px-3 bg-purple-50 text-purple-700 font-semibold" />

      <input type="text" id="name" placeholder="Your Name"
        class="w-full border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required />

      <input type="text" id="location" placeholder="Pickup Location"
        class="w-full border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required />

      <input type="date" id="pickupDate"
        class="w-full border rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required />

      <div class="flex justify-center gap-4 mt-2">
        <div class="flex flex-col items-center">
          <button type="button" onclick="adjust('hour', 1)" class="spinner-btn mb-1">‚ñ≤</button>
          <input type="text" id="pickupHour" class="time-input" value="12" readonly>
          <button type="button" onclick="adjust('hour', -1)" class="spinner-btn mt-1">‚ñº</button>
          <span class="text-gray-500 mt-1 text-sm">Hour</span>
        </div>
        <div class="flex flex-col items-center">
          <button type="button" onclick="adjust('minute', 1)" class="spinner-btn mb-1">‚ñ≤</button>
          <input type="text" id="pickupMinute" class="time-input" value="00" readonly>
          <button type="button" onclick="adjust('minute', -1)" class="spinner-btn mt-1">‚ñº</button>
          <span class="text-gray-500 mt-1 text-sm">Min</span>
        </div>
        <div class="flex flex-col items-center">
          <button type="button" onclick="toggleAMPM()" class="spinner-btn mb-1">‚ñ≤</button>
          <input type="text" id="pickupAMPM" class="time-input" value="AM" readonly>
          <button type="button" onclick="toggleAMPM()" class="spinner-btn mt-1">‚ñº</button>
          <span class="text-gray-500 mt-1 text-sm">AM/PM</span>
        </div>
      </div>

      <button type="submit"
        class="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white py-2 rounded-lg shadow-lg hover:scale-105 transition-transform duration-200">
        Confirm Pickup
      </button>
    </form>
  </main>

  <footer class="text-center text-gray-600 py-4 text-sm">
    ¬© 2025 Campus Marketplace
  </footer>

  <script>
    // üïí Time adjustment controls
    function adjust(unit, delta) {
      const hourInput = document.getElementById("pickupHour");
      const minuteInput = document.getElementById("pickupMinute");
      let hour = parseInt(hourInput.value);
      let min = parseInt(minuteInput.value);
      if (unit === "hour") {
        hour += delta;
        if (hour > 12) hour = 1;
        if (hour < 1) hour = 12;
        hourInput.value = hour.toString().padStart(2, "0");
      } else {
        min += delta;
        if (min > 59) min = 0;
        if (min < 0) min = 59;
        minuteInput.value = min.toString().padStart(2, "0");
      }
    }
    function toggleAMPM() {
      const ampm = document.getElementById("pickupAMPM");
      ampm.value = ampm.value === "AM" ? "PM" : "AM";
    }

    function getPickupTime() {
      const date = document.getElementById("pickupDate").value;
      let hour = parseInt(document.getElementById("pickupHour").value);
      const minute = parseInt(document.getElementById("pickupMinute").value);
      const ampm = document.getElementById("pickupAMPM").value;
      if (ampm === "PM" && hour < 12) hour += 12;
      if (ampm === "AM" && hour === 12) hour = 0;
      const dt = new Date(date);
      dt.setHours(hour, minute, 0, 0);
      return dt.toISOString();
    }

    // üßæ Page Setup
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
    const product = JSON.parse(localStorage.getItem("productForPickup"));

    if (!loggedInUser || !product) {
      alert("‚ö†Ô∏è Missing user or product details. Redirecting...");
      window.location.href = "index.html";
    }

    // Auto-fill details
    document.getElementById("productName").value = product?.name || "Unnamed Product";
    document.getElementById("name").value = loggedInUser?.name || "";

    // üß≠ Pickup submission
    const form = document.getElementById("pickupForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const pickupData = {
        userId: loggedInUser._id || loggedInUser.email,
        productId: product._id,
        name: document.getElementById("name").value.trim(),
        location: document.getElementById("location").value.trim(),
        time: getPickupTime(),
      };

      try {
        const res = await fetch("http://localhost:5000/api/pickups/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(pickupData),
        });

        const data = await res.json();

        if (data.success) {
          // ‚úÖ Store locally (for offline fallback)
          let pickups = JSON.parse(localStorage.getItem("myPickups")) || [];
          pickups.unshift({
            ...pickupData,
            pickupId: data.pickup._id,
            createdAt: new Date().toISOString(),
            productName: product.name,
          });
          localStorage.setItem("myPickups", JSON.stringify(pickups));

          alert("‚úÖ Pickup scheduled successfully!");
          localStorage.setItem("pickupId", data.pickup._id);

          // Redirect back to product page for payment
          window.location.href = "product.html?openPayment=true";
        } else {
          alert("‚ùå Failed to save pickup. Try again.");
        }
      } catch (err) {
        console.error("Pickup save error:", err);
        alert("‚ùå Server error while saving pickup.");
      }
    });
  </script>
</body>
</html>
