<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat ‚Äì Campus Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    .chat-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 1rem;
      word-wrap: break-word;
      transition: all 0.2s ease;
      animation: fadeInUp 0.2s;
    }
    .sender {
      background-color: #4f46e5;
      color: white;
      border-bottom-right-radius: 0;
    }
    .receiver {
      background-color: #f3f4f6;
      color: #111827;
      border-bottom-left-radius: 0;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col font-sans">

  <!-- Navbar -->
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <button onclick="window.location.href='chat-list.html'" class="text-gray-600 hover:text-indigo-600">
          ‚Üê Back
        </button>
        <div class="flex items-center space-x-2">
          <img id="chatAvatar" class="w-10 h-10 rounded-full object-cover border" />
          <div>
            <p id="chatName" class="font-semibold text-gray-800"></p>
            <p id="chatStatus" class="text-sm text-gray-400">Offline</p>
          </div>
        </div>
      </div>
      <a href="index.html" class="text-gray-600 hover:text-indigo-600">Home</a>
    </div>
  </header>

  <!-- Chat container -->
  <main class="flex-1 max-w-3xl mx-auto w-full px-4 py-6 flex flex-col">
    <div id="chatBox" class="flex-1 overflow-y-auto space-y-4 pb-4"></div>

    <!-- Input area -->
    <div class="flex items-center mt-4 bg-white p-3 rounded-xl shadow">
      <input 
        type="text" 
        id="messageInput" 
        placeholder="Type a message..." 
        class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
      />
      <button 
        id="sendBtn" 
        class="ml-3 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
      >
        Send
      </button>
    </div>
  </main>

  <footer class="bg-white shadow mt-auto">
    <div class="max-w-6xl mx-auto px-4 py-4 text-center text-gray-500 text-sm">
      ¬© 2025 Campus Marketplace. All rights reserved.
    </div>
  </footer>

  <script>
    const socket = io("http://localhost:5000");
    const API_URL = "http://localhost:5000/api/chats";

    // üß† Logged-in user + receiver
    const loggedUser = JSON.parse(localStorage.getItem("loggedInUser")) || { email: "demo@chitkara.edu.in" };
    const currentUser = loggedUser.email;
    const receiver = localStorage.getItem("chatWith");

    if (!receiver) {
      alert("No chat selected!");
      window.location.href = "chat-list.html";
    }

    // üß© DOM elements
    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const statusEl = document.getElementById("chatStatus");

    // üè† Setup UI
    document.getElementById("chatName").textContent = receiver;
    document.getElementById("chatAvatar").src = `https://i.pravatar.cc/150?u=${receiver}`;

    // üß© Unique room
    const room = [currentUser, receiver].sort().join("_");
    socket.emit("joinChat", room);

    // üü¢ Join personal room to get unread updates
    socket.emit("joinUser", currentUser);

    // üì¶ Load messages
    async function loadMessages() {
      try {
        const res = await fetch(`${API_URL}/${currentUser}/${receiver}`);
        const data = await res.json();
        renderChat(data.messages || []);

        // ‚úÖ Mark all messages as read when chat is opened
        await markMessagesRead();
      } catch (err) {
        console.error("Error loading messages:", err);
      }
    }

    // ‚úÖ Mark messages as read
    async function markMessagesRead() {
      try {
        await fetch(`${API_URL}/mark-read`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: currentUser, other: receiver }),
        });
      } catch (err) {
        console.error("Error marking messages read:", err);
      }
    }

    // üí¨ Render all messages
    function renderChat(messages) {
      chatBox.innerHTML = "";
      messages.forEach(msg => appendMessage(msg));
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // üß± Add single message
    function appendMessage(msg) {
      const div = document.createElement("div");
      div.className = `flex ${msg.sender === currentUser ? "justify-end" : "justify-start"}`;
      div.innerHTML = `
        <div class="chat-bubble ${msg.sender === currentUser ? "sender" : "receiver"}">
          <p>${msg.text}</p>
          <p class="text-xs mt-1 text-right ${msg.sender === currentUser ? "text-indigo-100" : "text-gray-500"}">
            ${new Date(msg.time || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </p>
        </div>
      `;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ‚úâÔ∏è Send message
    sendBtn.addEventListener("click", async () => {
      const text = messageInput.value.trim();
      if (!text) return;

      const messageData = {
        room,
        sender: currentUser,
        receiver,
        text,
        time: new Date().toISOString(),
      };

      socket.emit("sendMessage", messageData);
      messageInput.value = "";
    });

    // ‚èé Send on Enter
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // üì© Receive real-time messages
    socket.on("receiveMessage", async (msg) => {
      if (
        (msg.sender === currentUser && msg.receiver === receiver) ||
        (msg.sender === receiver && msg.receiver === currentUser)
      ) {
        appendMessage(msg);

        // Mark messages read if chat is open
        if (msg.sender === receiver) {
          await markMessagesRead();
        }
      }
    });

    // üü¢ Handle online/offline status
    socket.on("userStatusUpdate", ({ email, status }) => {
      if (email === receiver) {
        statusEl.textContent = status === "online" ? "Online" : "Offline";
        statusEl.className = status === "online" ? "text-sm text-green-500" : "text-sm text-gray-400";
      }
    });

    // üöÄ Initial load
    loadMessages();
  </script>
</body>
</html>
