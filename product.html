<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Product Details â€“ Campus Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #compact-reviews { scroll-behavior: smooth; }

    .wishlist-active svg {
      fill: #ef4444;
      stroke: #ef4444;
      transition: all 0.3s ease;
    }

    /* Fake Payment Modal Styling */
    #fakeModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    #fakeModal .modal-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      text-align: center;
    }

    /* shimmer while image loads */
    .image-wrapper {
      position: relative;
      min-height: 220px;
      background: linear-gradient(110deg, #f7f7f7 8%, #efefef 18%, #f7f7f7 33%);
      background-size: 200% 100%;
      animation: shimmer 1s linear infinite;
    }
    .image-wrapper.loaded {
      animation: none;
      background: transparent;
    }
    @keyframes shimmer { to { background-position-x: -200%; } }

    /* ensure modal hidden by default for no-flash */
    .hidden-by-default { display: none; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col font-sans">
  <!-- Navbar -->
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold text-indigo-600">Campus Marketplace</h1>
      <nav class="space-x-4">
        <a href="index.html" class="text-gray-600 hover:text-indigo-600">Home</a>
        <a href="listings.html" class="text-gray-600 hover:text-indigo-600">Listings</a>
        <a href="wishlist.html" class="text-gray-600 hover:text-indigo-600">Wishlist</a>
        <a href="profile.html" class="text-gray-600 hover:text-indigo-600">Profile</a>
        <a href="orders.html" class="text-gray-600 hover:text-indigo-600">My Orders</a>
      </nav>
    </div>
  </header>

  <!-- Product Section -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto mt-8 px-4 space-y-6">
      <!-- Product Card -->
      <!-- (unchanged code above) -->
      <!-- all your product, wishlist, seller info, and reviews code remains identical -->
    </div>
  </main>

  <!-- Fake Payment Modal -->
  <div id="fakeModal" class="hidden-by-default">
    <div class="modal-box">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">Fake Checkout</h3>
      <p id="modal-amount" class="text-indigo-600 font-medium mb-2"></p>
      <input id="txn" placeholder="txn_abc123" class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
      <div class="flex justify-end gap-3">
        <button id="cancelPay" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
        <button id="confirmPay" class="px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-10 bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 text-center text-gray-500 text-sm">
      Â© 2025 Campus Marketplace. All rights reserved.
    </div>
  </footer>

  <!-- Script -->
  <script>
    // safe parse helpers
    const safeJSON = (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch (e) { return null; } };

    const product = safeJSON('selectedProduct') || null;
    const loggedInUser = safeJSON('loggedInUser') || null;
    const userEmail = loggedInUser?.email || null;
    const API_URL = "http://localhost:5000/api/wishlist";
    const wishlistBtn = document.getElementById("wishlist-btn");
    const PLACEHOLDER = "https://via.placeholder.com/600x400?text=No+Image";

    // (your entire product setup, wishlist, and chat functions remain unchanged)

    // ðŸ†• Buy button now goes through pickup.html first (no change)
    const buyBtn = document.getElementById('buy-btn');
    const modal = document.getElementById('fakeModal');
    const modalAmount = document.getElementById('modal-amount');
    const confirmPay = document.getElementById('confirmPay');
    const cancelPay = document.getElementById('cancelPay');
    const txnInput = document.getElementById('txn');

    buyBtn.addEventListener('click', () => {
      if (!loggedInUser) {
        alert("Please log in to purchase items.");
        window.location.href = "login.html";
        return;
      }

      // Save selected product temporarily before going to pickup page
      localStorage.setItem("productForPickup", JSON.stringify(product));
  
      // Redirect to pickup page first
      window.location.href = "pickup.html?from=buy";
    });

    cancelPay.addEventListener('click', () => {
      modal.style.display = "none";
      modal.classList.add('hidden-by-default');
    });

    function addOrderToLocalStorage(orderData) {
      try {
        let orders = JSON.parse(localStorage.getItem("myOrders")) || [];
        orders.unshift(orderData);
        localStorage.setItem("myOrders", JSON.stringify(orders));
      } catch (e) {
        console.error("Saving order locally failed:", e);
      }
    }

    // ðŸ†• Backend-aware payment confirm
    confirmPay.addEventListener('click', async () => {
      try {
        const txnId = (txnInput.value || "").trim() || "txn_" + Math.random().toString(36).substr(2, 8);

        // ðŸ†• Pickup integration: get saved pickupId
        const pickupId = localStorage.getItem("pickupId");

        const orderPayload = {
          items: [{ productId: product?._id, name: product?.name, price: product?.price, qty: 1 }],
          amount: product?.price || 0,
          userId: loggedInUser?._id || null,
          pickupId: pickupId || null, // ðŸ†• attach pickup reference
        };

        const res = await fetch("http://localhost:5000/api/orders/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(orderPayload)
        });
        const data = await res.json();

        if (data?.success) {
          await fetch("http://localhost:5000/api/orders/mark-paid", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId: data.orderId, paymentMethod: "Fake", txnId })
          });

          addOrderToLocalStorage({
            id: data.orderId || "ORD" + Date.now(),
            status: "paid",
            items: [{ name: product?.name || "Item", price: product?.price || 0 }],
            amount: product?.price || 0,
            payment: { method: "Fake", txnId },
            createdAt: new Date().toISOString()
          });

          alert("âœ… Payment Successful! Order placed.\nTransaction: " + txnId);
          modal.style.display = "none";
          modal.classList.add('hidden-by-default');

          // ðŸ†• clear pickupId after order done
          localStorage.removeItem("pickupId");

          // redirect to orders page
          window.location.href = "orders.html";
        } else {
          alert("âŒ Failed to create order.");
        }
      } catch (err) {
        console.error("Payment error:", err);
        alert("âŒ Payment failed â€” check console.");
      }
    });

    // ðŸ†• When returning from pickup page, auto-open modal
    const queryParams = new URLSearchParams(window.location.search);
    if (queryParams.get("openPayment") === "true") {
      setTimeout(() => {
        modal.style.display = 'flex';
        modalAmount.innerText = "Amount: â‚¹" + product.price;
        txnInput.value = "txn_" + Math.random().toString(36).substr(2, 8);
      }, 500);
    }
  </script>
</body>
</html>
